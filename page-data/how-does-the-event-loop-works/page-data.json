{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-does-the-event-loop-works/","webpackCompilationHash":"d0813bbf0216c9d54282","result":{"data":{"site":{"siteMetadata":{"title":"Reactified","author":"Tal Avissar"}},"markdownRemark":{"id":"f09e2f84-cba6-5394-a7a5-6dac5b35a54f","html":"<p>The workings of the JavaScript dispatch queue are more subtle and interesting than you might think. Far from just being a queue of events, there are tasks and then there are sub-tasks.</p>\n<p>Lets look on this Javascript code</p>\n<h3>Tasks and Microtasks</h3>\n<p>Our earlier description of the event or dispatch queue is slightly over-simplified. Now that we have explored many of the possible ways of working with the queue it is time to find out some finer points of how it works.</p>\n<p>It is clear that each thread of execution gets its own queue. All of the windows from a single origin share the same queue, and this is used by the postMessage method to allow them to communicate.</p>\n<p>Tasks are originally the only thing placed in the event queue, but modern JavaScript and browsers also now support microtasks.</p>\n<p>The event loop takes tasks one at a time and allows the task to run to completion before the next task is serviced. Tasks can also be preferentially dequeued according to their source. This allows the system to prioritize some tasks.</p>\n<p>A subtle, but sometimes important point is that the browser may render updates to the page between servicing tasks. This is important because if your code makes changes to the page you will generally only see these changes if you allow the UI thread to service the queue and there has to be a task waiting for it to perform the update.</p>\n<p>Microtasks were introduced partly as a lightweight version of the task, but more to introduce a new class of task that was guaranteed to be executed before the next task starts i.e. as soon as possible</p>\n<h3>Tasks and Microtasks</h3>\n<p>Consider following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script start'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'setTimeout'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'promise2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script end'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In what order should the logs appear?</p>\n<p>The correct answer: script start, script end, promise1, promise2, setTimeout, but it’s really depends on the type of browser you’re using.</p>\n<p>Microsoft Edge, Firefox 40, iOS Safari and desktop Safari 8.0.8 log setTimeout before promise1 and promise2 - although it appears to be a race condition. This is really weird, as Firefox 39 and Safari 8.0.7 get it consistently right.</p>\n<p>To be continued …</p>","timeToRead":2,"frontmatter":{"title":"Tasks, microtasks and queues","date":"December 26, 2018","spoiler":"We talk about queues, tasks & micro tasks"},"fields":{"slug":"/how-does-the-event-loop-works/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/how-does-the-event-loop-works/","previous":{"fields":{"slug":"/private-and-public-class-fields/","langKey":"en","directoryName":"pages"},"frontmatter":{"title":"Public and private class fields"}},"next":{"fields":{"slug":"/how-to-use-rxjs-with-react/","langKey":"en","directoryName":"pages"},"frontmatter":{"title":"Rxjs explained and how to use with React"}},"translations":[],"translatedLinks":[]}}}